<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <style>
        * {
            margin: 0;
            padding: 0;
        }

        body {
            width: 100vw;
            height: 100vh;
            overflow: hidden;
        }

        #con {
            width: 800px;
            height: 600px;
            border: 10px solid black;
            position: relative;
            transform-style: preserve-3d;
            perspective: 1000;
            display: flex;
            flex-direction: column;
            justify-content: space-around;
            align-items: center;
        }
        #card_cover{
            width:100%;
            height:100%;
            position:absolute;
            left:0;
            top:0;
            background:black;
            z-index:11;
        }
        #transparent_cover{
            width:100%;
            height:100%;
            background:transparent;
            position:absolute;
            left:0;
            top:0;
            display:none;
            z-index:10;
        }
        .card_row {
            display: flex;
            justify-content: space-around;
            align-items: center;
            width: 100%;
        }

        .card_con {
            height: 100%;
            transition:.5s;
        }
        .card_front:hover{
            box-shadow:5px 5px 10px black;
        }

        .card {
            width: 100%;
            height: 100%;
            position: relative;
            transition: 1s;
            transform-style: preserve-3d;
            cursor:pointer;
        }

        .card_front {
            background: transparent;
            background-image:url('./img/card_front.png');
            background-size:100% 100%;
            position: absolute;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            backface-visibility: hidden;
            transition:.5s
        }

        .card_back {
            backface-visibility: hidden;
            width: 100%;
            height: 100%;
            position: absolute;
            left: 0;
            top: 0;
            transform: rotateY(180deg);
            display:flex;
            justify-content:center;
            align-items:center;
            border:3px solid black;
            border-radius:30px;
        }
        .card_image{
            width:50%;
            height:50%;
            background-size:100% 100%;
        }
        .card_on{
            transform:rotateY(180deg);
        }
        #board{
            position:absolute;
            border:3px solid black;
            width:250px;
            height:200px;
            left: 900px;
            top:100px;
            display:flex;
            justify-content:space-around;
            align-items:center;
            flex-direction:column;
        }
        .board_row{
            width:100%;
            height:40%;
            display:flex;
            justify-content:space-around;
            align-items:center;
            font-size:1.8rem;
            font-weight:bold;
        }
    </style>
</head>

<body>
    <button id="go">GO</button>
    <button id="back">Back</button>
    <div id="con">
        <div id="card_cover"></div>
        <div id="transparent_cover"></div>
    </div>
    <div id="board">
        <div class="board_row">
            <div>단계 :</div>
            <div id="board_stage"></div>
        </div>
        <div class="board_row">
            <div>남은 기회 : </div>
            <div id="board_chance"></div>
        </div>
    </div>
    <script>
        const go = document.getElementById('go');
        const back = document.getElementById('back');

        let cardStage = 2;

        const box = document.getElementById('box');
        let currentDegree = 0;
        go.addEventListener('click', () => {
            currentDegree += 360;
            box.style.transform = `rotateX(${currentDegree}deg)`;
        })
        back.addEventListener('click', () => {
            currentDegree -= 360;
            box.style.transform = `rotateX(${currentDegree}deg)`;
        })

        createCardGame(cardStage)
        // 1 단계 : 4장 2단계 6장 3단계 8장 4단계 10장 5단계 12장 6단계 14장 7단계 16장
        function createCardGame(cardStage) {
            const card_container = document.getElementById('con'); // 전체 컨테이너
            const cardImages = [];   // 카드에 들어갈 이미지 주소
            for(let i=0;i<27;i++){
                cardImages.push(`./img/animal${i}.png`);
            }

            card_container.innerHTML = ''; 
            //                   1,2,3, 4, 5, 6, 7  단계
            const stageList  = [0, 4, 6, 8, 12, 16, 18, 20];
            const defaultChance = [1, 2, 2, 3,  4,  4,  5,  5];
            const answer = createRandomArray(stageList[cardStage]);
            const checklist = answer.map(el=>el.sort((a,b)=>a-b).toString());
            const transparentCover = document.createElement('div')   // 버그 방지용 투명 커버
            transparentCover.id='transparent_cover';
            card_container.appendChild(transparentCover);
            const cardList = [];
            let input = [];
            let cardChance = defaultChance[cardStage-1];

            const boardStage = document.getElementById('board_stage');
            const boardChance = document.getElementById('board_chance')
            boardStage.textContent=cardStage;
            boardChance.textContent=cardChance;
            switch (stageList[cardStage]) {
                case 4:
                    for (let i = 0; i < 2; i++) {
                        const row = document.createElement('div');
                        row.style.height = '46%';
                        row.classList.add('card_row');
                        for (let j = 0; j < 2; j++) {
                            const cardCon = document.createElement('div');
                            const card = createCard();
                            cardCon.classList.add('card_con')
                            cardCon.style.width = '47%';
                            cardCon.appendChild(card);
                            row.appendChild(cardCon);
                            cardCon.onclick = (e) => {
                                const transparentCover = document.getElementById('transparent_cover');
                                card.style.transform = 'rotateY(180deg)'
                                input.push(2 * i + j);
                                setTimeout(() => {
                                    if (input.length === 2) {
                                        if (checkCardInput(input, answer)) {
                                            console.log('in setTImeout');
                                            console.log(input,answer);
                                            console.log(checklist);
                                            // 이미 성공한 카드 클릭 이벤트 제거
                                            const cards = document.querySelectorAll('.card_con');
                                            cards[input[0]].onclick='';
                                            cards[input[1]].onclick='';
                                            checklist.splice(checklist.indexOf(input.sort((a,b)=>a-b),1));
                                            if(checklist.length===0){
                                                console.log(`stage${cardStage} 성공`);
                                                cardStage++;
                                                createCardGame(cardStage);
                                            }
                                        } else {
                                            cardChance--;
                                            if(cardChance < 0){
                                                alert('실패!')
                                            }
                                        }
                                        input = [];
                                    }
                                }, 100)
                                console.log(input);
                                transparentCover.style.display='block';
                                setTimeout(()=>{
                                    transparentCover.style.display='none';
                                },1000)
                                console.log(2*i+j);
                                console.log(input);
                            }
                            cardList.push(card.children[1]);
                        }
                        card_container.appendChild(row);
                    }
                    answer.forEach(el => {
                        const image = cardImages.splice(Math.floor(Math.random() * cardImages.length), 1)[0]
                        el.forEach(element => {
                            console.log(cardList[element])
                            cardList[element].children[0].style.backgroundImage=`url(${image})`;
                        })
                    })
                    showCards(cardList);
                    break;
                    case 6:
                    for (let i = 0; i < 3; i++) {
                        const row = document.createElement('div');
                        row.style.height = '31%';
                        row.classList.add('card_row');
                        for (let j = 0; j < 2; j++) {
                            const cardCon = document.createElement('div');
                            const card = createCard();
                            cardCon.classList.add('card_con')
                            cardCon.style.width = '47%';
                            cardCon.appendChild(card);
                            row.appendChild(cardCon);
                            cardCon.onclick = (e) => {
                                const transparentCover = document.getElementById('transparent_cover');
                                card.style.transform = 'rotateY(180deg)'
                                input.push(2 * i + j);
                                setTimeout(() => {
                                    if (input.length === 2) {
                                        if (checkCardInput(input, answer)) {
                                            console.log('in setTImeout');
                                            console.log(input,answer);
                                            console.log(checklist);
                                            // 이미 성공한 카드 클릭 이벤트 제거
                                            const chosenCards = document.querySelectorAll('.card_con');
                                            chosenCards[input[0]].onclick='';
                                            chosenCards[input[1]].onclick='';
                                            checklist.splice(checklist.indexOf(input.sort((a,b)=>a-b),1));
                                            if(checklist.length===0){
                                                console.log(`stage${cardStage} 성공`);
                                                cardStage++;
                                                createCardGame(cardStage);
                                            }
                                        } else {
                                            cardChance--;
                                            console.log('실패했을 때 ' ,input);
                                            const chosenCard1 = document.querySelectorAll('.card')[input[0]];
                                            const chosenCard2 = document.querySelectorAll('.card')[input[1]];
                                            transparentCover.style.display='block';
                                            
                                            setTimeout(()=>{
                                                chosenCard1.style.transform='rotate(0)';
                                                chosenCard2.style.transform='rotate(0)';
                                                transparentCover.style.display='none';
                                            },800)
                                            boardStage.textContent=cardStage;
                                            boardChance.textContent=cardChance;
                                            if(cardChance < 1){
                                                alert('실패!')

                                            }
                                        }
                                        input = [];
                                    }
                                }, 100)
                                console.log(input);
                                transparentCover.style.display='block';
                                setTimeout(()=>{
                                    transparentCover.style.display='none';
                                },1000)
                                console.log(2*i+j);
                                console.log(input);
                            }
                            cardList.push(card.children[1]);
                        }
                        card_container.appendChild(row);
                    }
                    answer.forEach(el => {
                        const image = cardImages.splice(Math.floor(Math.random() * cardImages.length), 1)[0]
                        el.forEach(element => {
                            console.log(cardList[element])
                            cardList[element].children[0].style.backgroundImage=`url(${image})`;
                        })
                    })
                    showCards(cardList);
                    break;
            }
        }
        function showCards(cardList){
            const temp=[...cardList];
            const randomList =[];
            const transparentCover = document.getElementById('transparent_cover');
            transparentCover.style.display='block';
            for(let i=0;i<cardList.length ;i++){
                randomList.push(temp.splice(Math.floor(Math.random()*temp.length),1)[0]);
            }
            console.log(randomList);
            for(let i=0;i<cardList.length;i++){
                setTimeout(()=>{
                    randomList[i].parentNode.classList.add('card_on')
                    setTimeout(()=>{
                        randomList[i].parentNode.classList.remove('card_on');
                    },1000)
                },i*700)
            }
            setTimeout(()=>{
                transparentCover.style.display='none';
            }, cardList.length*700+1000)
        }
        function createRandomArray(cardStage) {
            const len = cardStage
            const arr = new Array(len).fill(0).map((el, idx) => idx);
            const temp = [];
            const result = [];
            while (arr.length !== 0) {
                temp.push(arr.splice(Math.floor(Math.random() * arr.length), 1)[0]);
            }
            while (temp.length !== 0) {
                result.push(temp.splice(0, 2));
            }
            return result;
        }

        function checkCardInput(input, answer) {
            const ans = answer.map(el => el.sort().map(e => e.toString()).join(''));
            const inp = input.sort((a, b) => a - b).map(el => el.toString()).join('');
            return ans.includes(inp) ? true : false;
        }

        function createCard() {
            const card = document.createElement('div');
            card.classList.add('card');
            const cardFront = document.createElement('div');
            const cardBack = document.createElement('div');
            const cardImage = document.createElement('div');

            cardFront.classList.add('card_front');
            cardBack.classList.add('card_back');
            cardImage.classList.add('card_image');

            cardBack.appendChild(cardImage);
            card.appendChild(cardFront);
            card.appendChild(cardBack);
            return card;
        }
    </script>
</body>

</html>